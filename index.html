<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Stacked Bar Chart</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>

<svg></svg>

<script type="text/javascript">

(async () => { 
  try {
    // Get the proposal data
    const response = await axios.get('proposals.json');

    const proposals = response.data.filter(d => d.assignToInstitution);

    // Group by status
    const statuses = d3.nest()
        .key(d => d.proposalStatus)
        .entries(proposals);

    statuses.sort((a, b) => d3.ascending(a.key, b.key))

    // Group by tic and then status
    const tics = d3.nest()
        .key(d => d.assignToInstitution)
        .key(d => d.proposalStatus)
        .entries(proposals);

    // Color scale
    const colorScale = d3.scaleOrdinal()
        .domain(statuses.map(d => d.key))
        .range(d3.schemeTableau10);

  /*
    const fillColor = req.query.fill || 'steelblue'
    d3n = new D3Node({
        styles: styles(fillColor),
        d3Module: d3,
    })
  */
    const width = 800;
    const height = 200;
    const margin = { top: 10, right: 10, bottom: 20, left: 110 };
    const innerWidth = width - margin.left - margin.right;
    const innerHeight = height - margin.top - margin.bottom;

    const xScale = d3.scaleLinear()
        .domain([0, d3.max(tics, d => d3.sum(d.values, d => d.values.length))])
        .range([0, innerWidth]);
    
    const yScale = d3.scaleBand()
        .domain(tics.map(d => d.key))
        .rangeRound([0, innerHeight])
        .paddingInner(0.4)
        .paddingOuter(0.4);

    // Set up for stacking
    tics.forEach(d => {
      let x = 0;

      d.values.sort((a, b) => d3.ascending(a.key, b.key));

      d.values.forEach(d => {
        d.x = x;
        x += xScale(d.values.length);
      });
    });

    //const svg = d3n.createSVG(svgWidth, svgHeight)
    const svg = d3.select('svg')
        .attr('width', width)
        .attr('height', height);

    const g = svg.append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    // Set up groups
    g.append('g').attr('class', 'labels');
    g.append('g').attr('class', 'backgrounds');
    g.append('g').attr('class', 'bars');
    g.append('g').attr('class', 'axis');

    // Draw bars
    const radius = 5;
    const pad = 2;

    svg.select('.bars').selectAll('.bar')
        .data(tics)
      .enter().append('g')
        .attr('class', 'bar')
        .attr('transform', d => 'translate(0,' + yScale(d.key) + ')')
      .selectAll('.section') 
        .data(d => d.values)
      .enter().append('rect')      
        .attr('class', 'section')
        .attr('x', d => d.x + pad / 2)
        .attr('width', d => xScale(d.values.length) - pad)
        .attr('height', yScale.bandwidth())
        .attr('rx', radius)
        .attr('ry', radius)
        .style('fill', d => colorScale(d.key))
        .on("mouseover", d => console.log(d));

    // Draw backgrounds
    svg.select('.backgrounds').selectAll('rect')
        .data(tics)
      .enter().append('rect')      
        .attr('class', 'section')
        .attr('y', d => yScale(d.key))
        .attr('width', d => xScale.range()[1])
        .attr('height', yScale.bandwidth())
        .attr('rx', radius)
        .attr('ry', radius)
        .style('fill', "#eee");

    // Draw labels
    svg.select('.labels').selectAll('text')
        .data(tics)
      .enter().append('text')
        .attr('dx', '-.5em')
        .attr('y', d => yScale(d.key) + yScale.bandwidth() / 2)
        .style('text-anchor', 'end')
        .style('font-family', 'arial')
        .style('font-size', 'small')
        .style('dominant-baseline', 'middle')
        .text(d => d.key);

    // Ddd the x Axis
    svg.select('.axis')
        .attr('transform', 'translate(0,' + innerHeight + ')')
        .call(d3.axisBottom(xScale))

    //res.status(200).type('application/xml').send(d3n.svgString())
  }
  catch (error) {
    console.log(error);
  }
})();

</script>

</body>